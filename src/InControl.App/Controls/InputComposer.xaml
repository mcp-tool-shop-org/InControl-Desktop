<?xml version="1.0" encoding="utf-8"?>
<UserControl
    x:Class="InControl.App.Controls.InputComposer"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:InControl.App.Controls">

    <UserControl.Resources>
        <!-- Model Selector Item Template -->
        <DataTemplate x:Key="ModelItemTemplate">
            <Grid Padding="4,6" ColumnSpacing="8">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>

                <FontIcon Grid.Column="0"
                          Glyph="&#xE950;"
                          FontSize="14"
                          Foreground="{ThemeResource TextFillColorSecondaryBrush}" />

                <TextBlock Grid.Column="1"
                           Text="{Binding}"
                           TextTrimming="CharacterEllipsis" />
            </Grid>
        </DataTemplate>
    </UserControl.Resources>

    <Border Background="{ThemeResource LayerFillColorDefaultBrush}"
            BorderBrush="{ThemeResource DividerStrokeColorDefaultBrush}"
            BorderThickness="0,1,0,0">
        <Grid Padding="16,12">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <!-- Control Bar (Top) - Model & Options -->
            <Grid Grid.Row="0" Margin="0,0,0,8">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <!-- Model Selector -->
                <ComboBox Grid.Column="0"
                          x:Name="ModelSelector"
                          PlaceholderText="Select model"
                          MinWidth="180"
                          TabIndex="0"
                          AutomationProperties.Name="Model selector"
                          AutomationProperties.HelpText="Choose the AI model for inference"
                          ItemTemplate="{StaticResource ModelItemTemplate}">
                    <ComboBox.Header>
                        <TextBlock Text="Model"
                                   Style="{StaticResource CaptionTextBlockStyle}"
                                   Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
                    </ComboBox.Header>
                </ComboBox>

                <!-- Context Attachments (Right side of control bar) -->
                <StackPanel Grid.Column="2"
                            Orientation="Horizontal"
                            Spacing="4">
                    <!-- Attach File Button -->
                    <Button x:Name="AttachFileButton"
                            ToolTipService.ToolTip="Attach file (Ctrl+Shift+O)"
                            Padding="8"
                            AutomationProperties.Name="Attach file"
                            AccessKey="A">
                        <FontIcon Glyph="&#xE723;" FontSize="14" />
                        <Button.KeyboardAccelerators>
                            <KeyboardAccelerator Key="O" Modifiers="Control,Shift" />
                        </Button.KeyboardAccelerators>
                    </Button>

                    <!-- Context Menu -->
                    <Button x:Name="ContextMenuButton"
                            ToolTipService.ToolTip="Context options"
                            AutomationProperties.Name="Context options">
                        <StackPanel Orientation="Horizontal" Spacing="4">
                            <FontIcon Glyph="&#xE8F1;" FontSize="14" />
                            <TextBlock x:Name="ContextCountText"
                                       Text="0"
                                       Style="{StaticResource CaptionTextBlockStyle}"
                                       Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                       Visibility="Collapsed" />
                        </StackPanel>
                        <Button.Flyout>
                            <MenuFlyout>
                                <MenuFlyoutItem x:Name="AddPreviousOutputMenuItem"
                                                Text="Add previous output"
                                                Icon="Copy" />
                                <MenuFlyoutItem x:Name="AddFileMenuItem"
                                                Text="Add file"
                                                Icon="OpenFile" />
                                <MenuFlyoutSeparator />
                                <MenuFlyoutItem x:Name="ClearContextMenuItem"
                                                Text="Clear all context"
                                                Icon="Delete"
                                                IsEnabled="False"
                                                ToolTipService.ToolTip="No context items to clear" />
                            </MenuFlyout>
                        </Button.Flyout>
                    </Button>
                </StackPanel>
            </Grid>

            <!-- Intent Input Area -->
            <Grid Grid.Row="1" MinHeight="60">
                <TextBox x:Name="IntentInput"
                         PlaceholderText="Enter your prompt..."
                         AcceptsReturn="False"
                         TextWrapping="Wrap"
                         ScrollViewer.VerticalScrollBarVisibility="Auto"
                         MaxHeight="200"
                         Padding="12"
                         BorderThickness="1"
                         BorderBrush="{ThemeResource ControlStrokeColorDefaultBrush}"
                         CornerRadius="4"
                         TabIndex="1"
                         AutomationProperties.Name="Prompt input"
                         AutomationProperties.HelpText="Enter your prompt here. Press Enter to send, Shift+Enter for new line." />
            </Grid>

            <!-- Disabled State Explanation Banner -->
            <Border x:Name="DisabledBanner"
                    Grid.Row="2"
                    Background="{ThemeResource SystemFillColorCautionBackgroundBrush}"
                    CornerRadius="4"
                    Padding="12,8"
                    Margin="0,8,0,8"
                    Visibility="Collapsed">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <FontIcon Grid.Column="0"
                              Glyph="&#xE7BA;"
                              FontSize="14"
                              Foreground="{ThemeResource SystemFillColorCautionBrush}"
                              Margin="0,0,12,0"
                              VerticalAlignment="Center" />

                    <TextBlock Grid.Column="1"
                               x:Name="DisabledReasonText"
                               Text="Select a model to enable Run"
                               Style="{StaticResource CaptionTextBlockStyle}"
                               VerticalAlignment="Center"
                               TextWrapping="Wrap" />

                    <Button Grid.Column="2"
                            x:Name="DisabledActionButton"
                            Content="Open Model Manager"
                            Padding="8,4"
                            FontSize="12"
                            VerticalAlignment="Center"
                            Visibility="Collapsed" />
                </Grid>
            </Border>

            <!-- Action Bar (Bottom) -->
            <Grid Grid.Row="3" Margin="0,8,0,0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <!-- Status / Hints -->
                <StackPanel Grid.Column="0"
                            Orientation="Horizontal"
                            Spacing="16"
                            VerticalAlignment="Center">
                    <!-- Character Count -->
                    <TextBlock x:Name="CharacterCount"
                               Text="0 characters"
                               Style="{StaticResource CaptionTextBlockStyle}"
                               Foreground="{ThemeResource TextFillColorTertiaryBrush}" />

                    <!-- Keyboard Hint -->
                    <TextBlock x:Name="KeyboardHint"
                               Text="Enter to send Â· Shift+Enter for new line"
                               Style="{StaticResource CaptionTextBlockStyle}"
                               Foreground="{ThemeResource TextFillColorTertiaryBrush}" />
                </StackPanel>

                <!-- Single Action Button (switches between Run and Cancel) -->
                <Button x:Name="ActionButton"
                        Grid.Column="1"
                        ToolTipService.ToolTip="Select a model to enable"
                        IsEnabled="False"
                        TabIndex="2"
                        AutomationProperties.Name="Run"
                        AccessKey="R">
                    <StackPanel Orientation="Horizontal" Spacing="6">
                        <FontIcon x:Name="ActionButtonIcon" Glyph="&#xE768;" FontSize="14" />
                        <TextBlock x:Name="ActionButtonText" Text="Run" />
                    </StackPanel>
                </Button>
            </Grid>
        </Grid>
    </Border>
</UserControl>
